@page "/lab_psi_audit"
@rendermode InteractiveServer
@using DAL = MOO.DAL.Pi
@using System.Text
@using System.Data
@attribute [Authorize(Roles = "Admin,BSC_Admin,M_OM_ADMIN,M_OM_MET")]


@inject Radzen.DialogService dialogService
@inject NotificationService notificationService

<PageTitle>@Util.PROGRAM_TITLE - PSI Audit</PageTitle>
<SectionContent SectionName="page-title">Minntac PSI Audit Entry</SectionContent>

<div class="row">
    <div class="col-4">
        <h5>Line:</h5>

        <RadzenNumeric @bind-Value="SelectedPSILine" TValue="byte" Change="LoadGrid" Min="3" Max="18" Style="width:100px"/>


        <RadzenCard class="mt-2">
            <h2>Add New Reading:</h2>
            <div class="row mb-2">
                <div class="col-4">
                    <h6>Lab Date:</h6>
                </div>
                <div class="col-4">
                    <RadzenDatePicker @bind-Value=@NewPAuditVal.Time DateFormat="MM/dd/yyyy" Required="true" ShowTime="false" />
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-4">
                    <h6>Lab Time (HHMM):</h6>
                </div>
                <div class="col-4">
                    <RadzenTextBox @bind-Value="NewPAuditTime" />
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-4">
                    <h6>Value:</h6>
                </div>

                <div class="col-8">
                    <RadzenNumeric ShowUpDown="false" TValue="double?" @bind-Value=@NewPAuditVal.Value />
                </div>
            </div>
            <RadzenButton Click="AddPSIBtnClickAsync" Text="Add Reading" IsBusy=IsSaving />
        </RadzenCard>
    </div>

    <div class="col-8">
        <div class="row mb-2">
            <div class="col">
                <RadzenButton Click="DeleteBtnClickedAsync" Icon="delete" ButtonStyle="ButtonStyle.Light" title="Delete Selected NOLA Audit" />
                <RadzenButton Click="LoadGrid" Icon="refresh" ButtonStyle="ButtonStyle.Light" title="Refresh Grid" />
            </div>
        </div>
        <RadzenDataGrid AllowFiltering="false" AllowPaging="false" AllowSorting="true" Data="@PSI_AuditHist"
                        TItem="DAL.Models.PSI_Audit" style="width:600px;height:500px" SelectionMode="DataGridSelectionMode.Single" @bind-Value=PSI_Selected>
            <Columns>
                <RadzenDataGridColumn TItem="DAL.Models.PSI_Audit" Property="Time" Title="Time" FormatString="{0:MM/dd/yyyy HH:mm}" />
                <RadzenDataGridColumn TItem="DAL.Models.PSI_Audit" Property="Lab" Title="Lab Value" />
                <RadzenDataGridColumn TItem="DAL.Models.PSI_Audit" Property="Psi" Title="PSI Value" FormatString="{0:N2}" />
                <RadzenDataGridColumn TItem="DAL.Models.PSI_Audit" Property="Solids" Title="Solids" FormatString="{0:N2}" />

            </Columns>
        </RadzenDataGrid>

    </div>

</div>



@code {
    private List<DAL.Models.PSI_Audit> PSI_AuditHist = new();
    private IList<DAL.Models.PSI_Audit> PSI_Selected = new List<DAL.Models.PSI_Audit>();
    private byte SelectedPSILine = 3;
    private byte[] PISLines = { 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18 };

    private Dictionary<string, DAL.Models.NOLA_Audit.NOLA_Type> NOLATypeList = new();

    private DAL.Models.PiComp2 NewPAuditVal = new();
    private string NewPAuditTime = "";
    private bool IsSaving = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            NewPAuditVal.Time = DateTime.Now;
            await LoadGrid();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task LoadGrid()
    {
        PSI_AuditHist = await Task.Run(() => DAL.Services.PSI_AuditSvc.GetPSIData(SelectedPSILine, DateTime.Now.AddDays(-20), DateTime.Now).OrderByDescending(a => a.Time).ToList());
        StateHasChanged();
    }


    private async Task DeleteBtnClickedAsync()
    {
        if (PSI_Selected.Count > 0)
        {
            bool? result = await dialogService.Confirm($"Delete PSI for Line {SelectedPSILine} for  {PSI_Selected[0].Time:MM/dd HH:mm}", "Are you sure?",
                                new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });
            if (result.GetValueOrDefault(false))
                DAL.Services.PSI_AuditSvc.DeletePsiAudit(SelectedPSILine, PSI_Selected[0].Time);

            await LoadGrid();
        }

    }


    private async Task AddPSIBtnClickAsync()
    {
        if (ValidateSelection())
        {
            if (MOO.Settings.ServerType == MOO.Settings.ServerClass.Production){
                IsSaving = true;
                await Task.Run(() => DAL.Services.PSI_AuditSvc.InsertPsiAudit(SelectedPSILine, NewPAuditVal.Time, NewPAuditVal.Value.GetValueOrDefault(0)));
                IsSaving = false;
                notificationService.Notify(new NotificationMessage()
                    {
                        Severity = NotificationSeverity.Info,
                        Summary = "Record Inserted",
                        Detail = "PSI Data Inserted",
                        Duration = 6000
                    });
            }                
            else
            {
                notificationService.Notify(new NotificationMessage()
                    {
                        Severity = NotificationSeverity.Warning,
                        Summary = "Data Not Inserted",
                        Detail = "Data was not inserted as this is a test server and there is no test PI Database",
                        Duration = 6000
                    });
            }

            //clear the selection but Ore Movement would like to keep the time entered
            DateTime saveDt = NewPAuditVal.Time;
            NewPAuditVal = new();
            NewPAuditVal.Time = saveDt;

            await LoadGrid();
        }
    }

    private bool ValidateSelection()
    {
        if (!CombineDateAndTime())
            return false;
        if (NewPAuditVal.Time > DateTime.Now.AddHours(1))
        {
            notificationService.Notify(new NotificationMessage()
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Invalid Date Selected",
                    Detail = "Cannot insert date into future",
                    Duration = 6000
                });
            return false;
        }
        if (!NewPAuditVal.Value.HasValue || NewPAuditVal.Value <= 0)
        {
            notificationService.Notify(new NotificationMessage()
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Invalid Value",
                    Detail = "Invalid PSI Value",
                    Duration = 6000
                });
            return false;
        }
       
        return true;
    }


    /// <summary>
    /// sets the NewPAuditVal.time to a combination of the time and the HHMM that was entered
    /// </summary>
    /// <returns>Returns false if time entered is invalid</returns>
    private bool CombineDateAndTime()
    {
        if (NewPAuditTime.Length != 4 || !int.TryParse(NewPAuditTime, out int timeInt))
        {
            notificationService.Notify(new NotificationMessage()
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Invalid Time Entry",
                    Detail = "Time must contain 4 characters",
                    Duration = 6000
                });
            return false;
        }

        int hours = timeInt / 100;
        int minutes = timeInt % 100;

        if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59)
        {
            notificationService.Notify(new NotificationMessage()
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Invalid Time Entry",
                    Detail = "Time value is invalid",
                    Duration = 6000
                });
            return false;
        }
        NewPAuditVal.Time = new DateTime(NewPAuditVal.Time.Year, NewPAuditVal.Time.Month, NewPAuditVal.Time.Day, hours, minutes, 0);
        return true;
    }
}